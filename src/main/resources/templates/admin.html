<!DOCTYPE html>
<html lang="zh" xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>后台管理</title>
    <link rel="stylesheet" href="/scoreQuery/bootstrap.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
      body {
        padding-top: 20px;
        padding-bottom: 20px;
        background: linear-gradient(135deg, #e0f7fa 0%, #bbdefb 100%); /* 渐变背景 */
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        justify-content: flex-start;
        align-items: center;
        font-family: 'Noto Sans SC', sans-serif;
        color: #333;
      }

      .container-fluid {
        width: 100%;
        padding: 15px;
      }

      h2 {
        color: #007bff;
        font-weight: 700;
        margin-bottom: 30px;
        letter-spacing: 1px;
      }

      .card {
        margin-bottom: 20px;
        border-radius: 15px;
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
        background-color: #ffffff;
        border: none;
      }

      .card-header {
        background: none;
        color: #007bff;
        border-radius: 15px 15px 0 0;
        font-weight: 700;
        padding: 1rem 1.5rem 0.5rem;
        font-size: 1.15rem;
        display: flex;
        align-items: center;
        border-bottom: none;
      }
      .card-header i {
        margin-right: 10px;
        font-size: 1.2em;
        color: #007bff;
      }
      .card-body {
        padding: 1rem 1.5rem 1.5rem;
      }


      .filter-section {
        padding: 20px;
      }
      .filter-row {
        display: flex;
        flex-wrap: wrap;
        margin-bottom: 10px;
        align-items: center;
      }
      .filter-item {
        margin-right: 20px;
        margin-bottom: 10px;
        display: flex;
        align-items: center;
      }
      .filter-item label {
        margin-right: 5px;
        font-weight: 500;
        color: #555;
      }
      .filter-buttons {
        margin-top: 10px;
        display: flex;
        gap: 10px;
      }

      .class-card-container {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
      }
      .class-card {
        padding: 5px 12px;
        border: 1px solid #007bff;
        border-radius: 5px;
        background-color: #e0f7fa;
        color: #007bff;
        cursor: pointer;
        transition: all 0.2s ease-in-out;
        font-size: 0.9em;
      }
      .class-card:hover {
        background-color: #cce7ff;
        border-color: #0056b3;
      }
      .class-card.selected {
        background-color: #007bff;
        color: white;
        border-color: #0056b3;
      }

      .btn-primary {
        background-color: #007bff;
        border-color: #007bff;
        border-radius: 8px;
        height: 40px;
        font-size: 1rem;
        font-weight: 500;
        transition: all 0.3s ease;
      }
      .btn-primary:hover {
        background-color: #0056b3;
        border-color: #0056b3;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 123, 255, 0.3);
      }
      .btn-secondary {
        background-color: #6c757d;
        border-color: #6c757d;
        border-radius: 8px;
        height: 40px;
        font-size: 1rem;
        font-weight: 500;
        transition: all 0.3s ease;
      }
      .btn-secondary:hover {
        background-color: #5a6268;
        border-color: #545b62;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(108, 117, 125, 0.3);
      }

      .radio-button-group {
        display: flex;
        gap: 10px;
      }
      .radio-button-group label.form-check-label {
        padding: 8px 15px;
        border: 1px solid #ced4da;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s ease;
        background-color: #f8f9fa;
      }
      .radio-button-group input[type="radio"] {
        display: none;
      }
      .radio-button-group input[type="radio"]:checked + label {
        background-color: #007bff;
        color: white;
        border-color: #007bff;
        box-shadow: 0 2px 4px rgba(0, 123, 255, 0.2);
      }
      .radio-button-group label.form-check-label:hover {
        background-color: #e2e6ea;
      }


      /* Desktop Table View */
      .table-desktop {
        display: block; /* 默认显示 */
        width: 100%;
        border-radius: 10px; /* 统一表格圆角 */
        overflow: hidden; /* 隐藏超出圆角的部分 */
      }
      .table-desktop .table-sm th, .table-desktop .table-sm td {
        padding: 0.5rem;
        vertical-align: middle;
      }
      .table-desktop .table-striped tbody tr:nth-of-type(odd) {
        background-color: rgba(0, 0, 0, 0.03);
      }
      .table-desktop .table th, .table-desktop .table td {
        white-space: normal;
        word-wrap: break-word;
      }
      .table-desktop .table th:nth-child(1), .table-desktop .table td:nth-child(1) { width: 6%; text-align: center; }  /* 手机号 */
      .table-desktop .table th:nth-child(2), .table-desktop .table td:nth-child(2) { width: 8%; text-align: center; } /* 教学班级 */
      .table-desktop .table th:nth-child(3), .table-desktop .table td:nth-child(3) { width: 8%; text-align: center; }  /* 班级 */
      .table-desktop .table th:nth-child(4), .table-desktop .table td:nth-child(4) { width: 5%; text-align: center;}  /* 姓名 */
      .table-desktop .table th:nth-child(5), .table-desktop .table td:nth-child(5) { width: 5%; text-align: center;}  /* 期末 */
      .table-desktop .table th:nth-child(6), .table-desktop .table td:nth-child(6) { width: 5%; text-align: center;}  /* 平时 */
      .table-desktop .table th:nth-child(7), .table-desktop .table td:nth-child(7) { width: 5%; text-align: center;}  /* 总评 */
      .table-desktop .table th:nth-child(8), .table-desktop .table td:nth-child(8) { width: 20%; } /* 评语 */
      .table-desktop .table th:nth-child(9), .table-desktop .table td:nth-child(9) { width: 20%; } /* 留言 */
      .table-desktop .table th:nth-child(10), .table-desktop .table td:nth-child(10) { width: 5%; text-align: center;}  /* 是否查询 */

      .table-desktop .table th {
        text-align: center;
        background-color: #f2f7fb;
        color: #007bff;
        border-bottom: 2px solid #dee2e6;
      }
      .table-desktop .table {
        width: 100%;
        table-layout: fixed;
        border-collapse: separate;
        border-spacing: 0;
        border: 1px solid #dee2e6; /* 整体边框 */
      }
      /* 表格圆角 */
      .table-desktop .table thead th:first-child { border-top-left-radius: 10px; }
      .table-desktop .table thead th:last-child { border-top-right-radius: 10px; }
      .table-desktop .table tbody tr:last-child td:first-child { border-bottom-left-radius: 10px; }
      .table-desktop .table tbody tr:last-child td:last-child { border-bottom-right-radius: 10px; }


      /* Mobile Card List View */
      .card-list-mobile {
        display: none; /* 默认隐藏 */
        margin-top: 20px;
      }
      .student-card-item {
        background-color: #ffffff;
        border-radius: 15px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        margin-bottom: 15px;
        padding: 15px;
        cursor: pointer;
        transition: all 0.3s ease;
        position: relative; /* 用于展开/收起箭头 */
        overflow: hidden; /* 防止内容溢出圆角 */
      }
      .student-card-item:hover {
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        transform: translateY(-2px);
      }
      .student-card-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 10px;
        padding-right: 30px;
      }
      .student-card-header .name-class {
        font-size: 1.15rem;
        font-weight: 700;
        color: #007bff;
        flex-grow: 1;
        min-width: 0;
        white-space: normal;
      }
      .student-card-header .name-class small {
        font-size: 0.9em;
        display: block;
        margin-top: 2px;
      }
      .student-card-header .score-status {
        display: flex;
        flex-shrink: 0;
        align-items: center;
        gap: 8px;
        padding-left: 10px;
        margin-left: auto;
      }
      .student-card-header .total-score {
        font-size: 1.2rem;
        font-weight: 700;
        color: #28a745;
        min-width: 40px;
        text-align: right;
        white-space: nowrap;
      }
      .student-card-header .checked-status {
        font-size: 0.85em;
        padding: 3px 6px;
        border-radius: 5px;
        font-weight: 600;
        white-space: nowrap;
      }
      .student-card-header .checked-status.is-checked {
        background-color: #d4edda;
        color: #155724;
      }
      .student-card-header .checked-status.not-checked {
        background-color: #f8d7da;
        color: #721c24;
      }

      .student-card-details {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.4s ease-out;
        padding-top: 0;
      }
      .student-card-details.show {
        max-height: 500px;
        padding-top: 15px;
      }
      .detail-row {
        display: flex;
        justify-content: space-between;
        margin-bottom: 5px;
        font-size: 0.95rem;
        color: #555;
      }
      .detail-label {
        font-weight: 500;
        color: #444;
        flex-shrink: 0;
        margin-right: 10px;
      }
      .detail-value {
        text-align: right;
        flex-grow: 1;
        white-space: pre-line;
        word-wrap: break-word;
      }
      .detail-full-width {
        margin-top: 10px;
      }
      .detail-full-width .detail-value {
        margin-top: 5px;
        text-align: left;
        padding: 8px 10px;
        background-color: #f0f8ff;
        border-radius: 8px;
        border: 1px solid #e0f7fa;
      }

      .expand-arrow {
        position: absolute;
        top: 18px;
        right: 15px;
        font-size: 1.1em;
        color: #007bff;
        transition: transform 0.3s ease;
      }
      .student-card-item.expanded .expand-arrow {
        transform: rotate(90deg);
      }


      /* 进度条样式 */
      .progress {
        height: 25px;
        margin-bottom: 15px;
        background-color: #e9ecef;
        border-radius: 8px;
      }
      .progress-bar {
        background-color: #28a745;
        color: #ffffff;
        text-align: center;
        font-size: 0.9em;
        line-height: 25px;
        border-radius: 8px;
        transition: width 0.6s ease;
      }

      .text-green { color: #28a745; font-weight: bold; }
      .text-red { color: #dc3545; font-weight: bold; }

      footer {
        margin-top: 30px;
        color: #6c757d;
        font-size: 0.9rem;
      }

      /* 媒体查询：手机端适配 */
      @media (max-width: 768px) {
        .container-fluid {
          padding: 10px;
        }
        .table-desktop {
          display: none;
        }
        .card-list-mobile {
          display: block;
        }
        .filter-row { /* 针对每个filter-row本身进行flex-direction调整 */
          flex-direction: column;
          align-items: flex-start;
          margin-bottom: 15px;
        }
        .filter-item { /* 调整filter-item以适应单行显示标签+换行显示内容 */
          margin-right: 0;
          margin-bottom: 5px; /* 标签和其内容之间的小间距 */
          width: 100%; /* 占据整行 */
          flex-direction: column; /* 让 label 和 class-card-container/radio-group 垂直排列 */
          align-items: flex-start; /* 左对齐 */
        }
        .filter-item label { /* 标签下方有间距 */
          margin-bottom: 8px;
          margin-right: 0; /* 移除右侧间距 */
        }
        .class-card-container, .radio-button-group { /* 确保列表/按钮组占据整行 */
          width: 100%;
          justify-content: flex-start;
          margin-bottom: 5px; /* 确保自身内容和下一个筛选项有间距 */
        }
        .class-card {
          padding: 6px 12px;
          font-size: 0.9em;
        }
        .radio-button-group {
          flex-wrap: wrap;
          gap: 8px;
        }
        .radio-button-group label.form-check-label {
          padding: 10px 15px;
          font-size: 1rem;
        }
        .btn-primary, .btn-secondary {
          height: 45px;
          font-size: 1.05rem;
          width: 100%;
        }
        .filter-buttons {
          flex-direction: column;
          gap: 10px;
          width: 100%;
        }
      }
    </style>
  </head>
  <body>
    <div class="container-fluid">
      <h2 class="text-center">后台管理</h2>

      <div class="card">
        <div class="card-header">
          <i class="fas fa-filter"></i> 筛选条件
        </div>
        <div class="card-body filter-section">
          <form id="filterForm" th:action="@{/admin}" method="get">
            <input type="hidden" name="password" th:value="${params.password}">
            <input type="hidden" id="selectedTeachingClassNames" name="teachingClassNames" th:value="${params.teachingClassNames != null ? #strings.arrayJoin(params.teachingClassNames, ',') : ''}">


            <div class="filter-row">
              <div class="filter-item"> <!-- 注意这里的 flex-direction 和 align-items 会被媒体查询覆盖 -->
                <label><i class="fas fa-chalkboard-teacher"></i> 教学班级：</label>
                <div class="class-card-container">
                            <span th:each="tcName : ${allTeachingClassNames}"
                                  th:data-class-name="${tcName}"
                                  th:classappend="${params.teachingClassNames != null and params.teachingClassNames.contains(tcName) ? 'selected' : ''}"
                                  class="class-card">
                                <span th:text="${tcName}"></span>
                            </span>
                </div>
              </div>
            </div>

            <div class="filter-row">
              <div class="filter-item">
                <label><i class="fas fa-eye"></i> 是否查询：</label>
                <div class="radio-button-group">
                  <input type="radio" name="isChecked" id="checkedTrue" value="true"
                         th:checked="${params.isChecked != null and params.isChecked == true}">
                  <label class="form-check-label" for="checkedTrue">是</label>

                  <input type="radio" name="isChecked" id="checkedFalse" value="false"
                         th:checked="${params.isChecked != null and params.isChecked == false}">
                  <label class="form-check-label" for="checkedFalse">否</label>

                  <input type="radio" name="isChecked" id="checkedAll" value=""
                         th:checked="${params.isChecked == null}">
                  <label class="form-check-label" for="checkedAll">全部</label>
                </div>
              </div>
            </div>

            <div class="filter-row">
              <div class="filter-item">
                <label><i class="fas fa-comment-alt"></i> 是否有留言：</label>
                <div class="radio-button-group">
                  <input type="radio" name="hasFeedback" id="feedbackTrue" value="true"
                         th:checked="${params.hasFeedback != null and params.hasFeedback == true}">
                  <label class="form-check-label" for="feedbackTrue">是</label>

                  <input type="radio" name="hasFeedback" id="feedbackFalse" value="false"
                         th:checked="${params.hasFeedback != null and params.hasFeedback == false}">
                  <label class="form-check-label" for="feedbackFalse">否</label>

                  <input type="radio" name="hasFeedback" id="feedbackAll" value=""
                         th:checked="${params.hasFeedback == null}">
                  <label class="form-check-label" for="feedbackAll">全部</label>
                </div>
              </div>
            </div>

            <div class="filter-buttons">
              <button type="submit" class="btn btn-primary btn-sm"><i class="fas fa-search"></i> 筛选</button>
              <button type="button" class="btn btn-secondary btn-sm"
                      th:attr="data-password=${params.password}" onclick="resetFilters(this)">
                <i class="fas fa-sync-alt"></i> 重置
              </button>
            </div>
          </form>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <i class="fas fa-chart-bar"></i> 统计信息
        </div>
        <div class="card-body">
          <p>查询率：<strong th:text="${queryRate}">0.00%</strong></p>
          <div class="progress">
            <div class="progress-bar" role="progressbar" th:style="'width: ' + ${queryRateValue} + '%'" th:aria-valuenow="${queryRateValue}" aria-valuemin="0" aria-valuemax="100">
              <span th:text="${queryRate}"></span>
            </div>
          </div>
          <p>留言率：<strong th:text="${feedbackRate}">0.00%</strong></p>
          <div class="progress">
            <div class="progress-bar" role="progressbar" th:style="'width: ' + ${feedbackRateValue} + '%'" th:aria-valuenow="${feedbackRateValue}" aria-valuemin="0" aria-valuemax="100">
              <span th:text="${feedbackRate}"></span>
            </div>
          </div>
          <p>筛选结果总人数：<strong th:text="${filteredStudentCount}">0</strong></p>
        </div>
      </div>

      <!-- Desktop Table View -->
      <div class="card table-desktop">
        <div class="card-header">
          <i class="fas fa-users"></i> 学生列表
        </div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-bordered table-striped table-sm">
              <thead>
                <tr>
                  <th>手机号</th>
                  <th>教学班级</th>
                  <th>班级</th>
                  <th>姓名</th>
                  <th>期末成绩</th>
                  <th>平时成绩</th>
                  <th>总评</th>
                  <th>评语</th>
                  <th>留言</th>
                  <th>是否查询</th>
                </tr>
              </thead>
              <tbody>
                <tr th:each="student : ${students}">
                  <td th:text="${student.phone}">13888888888</td>
                  <td th:text="${student.teachingClassName}">编程提高班A</td>
                  <td th:text="${student.className}">一年级一班</td>
                  <td th:text="${student.name}">小明</td>
                  <td th:text="${student.finalScore}">A</td>
                  <td th:text="${student.usualScore}">B</td>
                  <td th:text="${student.totalScore}">A</td>
                  <td th:text="${student.comment}">好好表现</td>
                  <td th:text="${student.feedback}">老师很棒！</td>
                  <td>
                            <span th:classappend="${student.checked ? 'text-green' : 'text-red'}"
                                  th:text="${student.checked ? '是' : '否'}">是</span>
                  </td>
                </tr>
                <tr th:if="${#lists.isEmpty(students)}">
                  <td colspan="10" class="text-center">没有找到符合条件的学生数据。</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Mobile Card List View -->
      <div class="card card-list-mobile">
        <div class="card-header">
          <i class="fas fa-users"></i> 学生列表
        </div>
        <div class="card-body">
          <div th:if="${#lists.isEmpty(students)}" class="text-center text-muted p-4">
            没有找到符合条件的学生数据。
          </div>
          <div th:each="student : ${students}" class="student-card-item" th:data-student-id="${student.id}"
               onclick="toggleStudentDetails(this)">
            <span class="expand-arrow"><i class="fas fa-chevron-right"></i></span>
            <div class="student-card-header">
              <div class="name-class">
                <span th:text="${student.name}">小明</span>
                <!-- 强制班级换行显示在姓名下方，并显示班级而不是教学班级 -->
                <small class="text-muted" th:if="${student.className}" th:text="${'(' + student.className + ')'}"></small>
              </div>
              <div class="score-status">
                         <span th:classappend="${'total-score grade-' + (student.totalScore != null ? student.totalScore.trim().substring(0,1).toLowerCase() : 'other')}"
                               th:text="${student.totalScore ?: 'N/A'}">A</span>
                <span th:classappend="${student.checked ? 'checked-status is-checked' : 'checked-status not-checked'}"
                      th:text="${student.checked ? '已查询' : '未查询'}">已查询</span>
              </div>
            </div>
            <div class="student-card-details">
              <div class="detail-row">
                <span class="detail-label">手机号：</span>
                <span class="detail-value" th:text="${student.phone}">13888888888</span>
              </div>
              <div class="detail-row">
                <span class="detail-label">教学班级：</span>
                <span class="detail-value" th:text="${student.teachingClassName}">编程提高班A</span>
              </div>
              <div class="detail-row" th:if="${student.finalScore}">
                <span class="detail-label">期末成绩：</span>
                <span class="detail-value" th:classappend="${'grade-' + student.finalScore.trim().substring(0,1).toLowerCase()}"
                      th:text="${student.finalScore}"></span>
              </div>
              <div class="detail-row" th:if="${student.usualScore}">
                <span class="detail-label">平时成绩：</span>
                <span class="detail-value" th:classappend="${'grade-' + student.usualScore.trim().substring(0,1).toLowerCase()}"
                      th:text="${student.usualScore}"></span>
              </div>
              <div class="detail-full-width" th:if="${student.comment}">
                <span class="detail-label">评语：</span>
                <div class="detail-value" th:text="${student.comment}"></div>
              </div>
              <div class="detail-full-width" th:if="${student.feedback}">
                <span class="detail-label">留言：</span>
                <div class="detail-value" th:text="${student.feedback}"></div>
              </div>
            </div>
          </div>
        </div>
      </div>


    </div>

    <footer style="text-align: center">
      <p>© Namelessman 林煜耿 2024</p>
    </footer>

    <script src="/scoreQuery/jquery.js"></script>
    <script src="/scoreQuery/popper.js"></script>
    <script src="/scoreQuery/bootstrap.js"></script>
    <script>
      // 用于重置筛选条件的函数
      function resetFilters(button) {
        var password = button.getAttribute('data-password');
        var contextPath = window.location.pathname.substring(0, window.location.pathname.indexOf("/admin"));
        if (contextPath === "") {
          contextPath = "/scoreQuery"; // 默认上下文路径
        }
        location.href = contextPath + '/admin?password=' + password;
      }

      // 处理教学班级卡片点击事件
      $(document).ready(function() {
        var $hiddenInput = $('#selectedTeachingClassNames');
        var selectedClassNames = $hiddenInput.val() ? $hiddenInput.val().split(',') : [];

        $('.class-card').on('click', function() {
          var $this = $(this);
          var className = $this.data('class-name');

          if ($this.hasClass('selected')) {
            $this.removeClass('selected');
            selectedClassNames = selectedClassNames.filter(name => name !== className);
          } else {
            $this.addClass('selected');
            selectedClassNames.push(className);
          }
          $hiddenInput.val(selectedClassNames.join(','));
        });
      });

      // 手机端卡片展开/收起功能
      function toggleStudentDetails(element) {
        $(element).toggleClass('expanded');
        var details = $(element).find('.student-card-details');
        details.toggleClass('show');
      }
    </script>
  </body>
</html>
